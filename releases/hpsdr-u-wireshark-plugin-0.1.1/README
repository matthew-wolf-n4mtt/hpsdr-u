31-JAN-2016 Matthew J. Wolf <matthew.wolf.hpsdr@speciosus.net>

The HPSDR-USB Plug-in for Wireshark is written to disassemble the protocol
that is defined in the documents listed below.
 
Metis - How it Works_V1.33: 28-Feb-2015
http://svn.tapr.org/repos_sdr_hpsdr/trunk/Metis/Documentation/Metis-%20How%20it%20works_V1.33.pdf  

HPSDR - USB Data Protocol, Version 1.58: 4-Aug-2014
http://svn.tapr.org/repos_sdr_hpsdr/trunk/Documentation/USB_protocol_V1.58.doc

Version: 0.1.0
 - There is no disassembly of status 3 datagrams. Status 3 is used to
   manually set the SDR's IP address and program the SDR's firmware.
 - There is no disassembly of USB end point 4 datagrams. USB end point 4 
   is used for sending raw ADC (Wide Band-scope) samples to the HOST. The 
   Wide Band-scope bit in the Start / Stop Command is disassembled. 

Version: 0.1.1
 - While waiting for SVN access I started to work on a plug-in for the openHPSDR 
   Ethernet Protocol. Both the USB over IP and the Ethernet protocol use UDP 
   port 1024. This means that the two plug-ins have to coexist with each other.
 - Changed the plug-in to registering as heuristic dissector. The plug-in tests 
   the first two bytes of the UDP payload for the 0xEFFE id. Then it does not 
   see the ID it exits. 
 - I do not forsee any more updates until I finish the plug-in for the openHPSDR 
   Ethernet Protocol. 
-------------------------------------------------------------------------------

Only use the plug-in disassembly of the protocol as tool. Do not rely on it to
tell you exactly what is happening with the SDR or the host application. This 
plug-in calculates numbers for some objects. One example is the TX forward 
power. Only use the calculated number if you know for a fact that the SDR is 
truly transmitting. If the SDR is not transmitting and the plug-in reports a 
positive value for the forward power. Disregard the calculated power.


The disassembler in the plug-in attempts to identify which IQ bits belong to 
which receiver when there are multiple receivers. It will also identify the pad
bits. The disassembler only records the number of receivers when it believes the 
SDR is not sending IQ data. I had add this limitation because some of the host 
applications stop sending the correct number of receivers in the USB end point 2 
frames after it sends the start command to the SDR.

The disassembler believes the SDR is not sending IQ data when it first starts to 
disassemble the datagrams. If the disassembly is started after
the IQ start command is sent, the number of receivers in the USB end point 2 C&C 
C0=0x00 USB frame will be used for the number of receivers. This also means when
the host application does not report the correct number receivers. The 
disassembler will not be able to correctly identify which IQ bits go with which 
receivers.       

The disassembler will stop recording the number of receivers when it sees a IQ 
start command. It will not record number of receivers again until it sees a stop
command. This is a work round for host applications that stop reporting the 
correct number of receivers. The application has to tell the SDR the correct 
number of receivers before it sends the start command. After the start command, 
I assume the SDR does not need the application to report the correct number of 
receivers.

OK, if you do not care about the last paragraph. What you need to do with 
applications that do not all send the correct number of receivers is:
1. Start the packet capture before the host application sends the start command.
2. You need to make sure that you capture the USB end point 2 frame where the 
    host application tells the SDR then number of receivers right before it sends
    the IQ start command
3. Then make sure you capture the host application sending the start command.
4. More simply start the capture before for start the host application! 


There is one item I had to add for misbehaving host applications. Some 
applications send the first USB end point 2 frame late. They add extra empty 
bytes between the end of the sequence number and the start of the USB frame.
The disassembler searches for the first USB sync bytes. When the sync bytes are
not right after the sequence number the disassembler displays a warring that 
there are extra bits. Once the disassembler finds the sync bytes, it 
disassembles the USB frames.

   



